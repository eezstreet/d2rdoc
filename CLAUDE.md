# D2R Dataguide

This is a repository provided by Blizzard Entertainment for Diablo II: Resurrected v3.1.0.

The `python/` folder contains scripts used to generate and validate the HTML documentation site. The generated output lives in `files/` (HTML pages) and `data/search.js` (search index).

## Project Structure

```
data/
  dataguidefieldexport.json   # Source of truth: field names, types, dataLength, memSize exported from game code
  files/*.js                  # One JS file per game data file, wrapping JSON in a files["key"] = {...} assignment
  search.js                   # Generated search index (do not edit by hand)
  siteIndex.js                # Site navigation index
  template.html               # HTML template used to generate pages in files/
files/*.html                  # Generated HTML pages (do not edit by hand)
docs/                         # Hand-authored supplemental documentation pages
python/
  update_fileguide.py         # Main CLI entry point — orchestrates all other scripts
  generate_js_files.py        # Syncs data/files/*.js with dataguidefieldexport.json
  generate_html_files.py      # Generates files/*.html from data/files/*.js + data/template.html
  generate_search.py          # Generates data/search.js from data/files/*.js
  validate.py                 # Validates data/files/*.js for correctness
```

## Python Scripts

### `update_fileguide.py` — Main Entry Point

Parses CLI arguments and calls the other scripts. Usage:
```
python python/update_fileguide.py -a <all|files|search|validate> -data <data-dir> [-html <html-dir>] [-p]
```
See README.md for full argument documentation.

### `generate_js_files.py`

Reads `data/dataguidefieldexport.json` (the game code's authoritative field export) and syncs each `data/files/*.js` file to match. Specifically:
- Adds any fields present in the export but missing from the JS file, with empty `description` stubs.
- Updates `type`, `dataLength`, and `memSize` on existing fields to match the export.
- Creates new JS stub files for any game files present in the export but missing entirely from `data/files/`.
- Respects `ignoreFields`, `appendFiles`, `guideOnly`, and `codeDependency` file-level properties.
- Optionally checks out / adds files via Perforce (`-p`).

### `generate_html_files.py`

For each `data/files/*.js`, generates a corresponding `files/*.html` page by:
1. Reading the JS file, stripping the JS wrapper to extract the JSON title and `referenceFiles`.
2. Filling `data/template.html` placeholders: `<##>` → title, `<@@>` → file key, `<$$>` → `<script>` tags for `referenceFiles`.
3. Writing the result to `files/<key>.html`.
Files with `"noHtml": true` are skipped.

### `generate_search.py`

Builds `data/search.js`, a JS constant (`const search = [...]`) that indexes all searchable files. For each file it records the page title and path, plus every field name, `altName`, and table `id` anchor. Files with `"notSearchable": true` are excluded.

### `validate.py`

Validates all `data/files/*.js` against `dataguidefieldexport.json`. Checks include:
- Every file has a non-empty `title` and `overview`.
- Every field has a non-empty `name` and `description`.
- Field `type`, `dataLength`, and `memSize` match what the code export expects.
- `reference` type fields have non-empty `file` and `field` that resolve to real targets.
- `parse` type fields have a non-empty `description`.
- All `referenceFiles` and `appendFiles` keys resolve to existing files.
- All reference links (`$!..!$`) in text strings resolve to existing files/fields.
- No duplicate field names within a file (including across `appendFiles`).
- No field listed in both `ignoreFields` and `fields`.
- All code-expected fields are documented (or listed in `ignoreFields`).

## Holes in the Data

Fields and files that were auto-generated by `generate_js_files.py` but not yet documented by an author have these empty stubs that will fail `validate`:
- `"description": ""` on fields
- `"title": ""` or `"overview": ""` on files
- `"file": ""` / `"field": ""` on `reference` type fields
- `"description": ""` on `parse` type fields

Running `validate` will print all such gaps to stdout.

## Data File Format

Each `data/files/*.js` file looks like:
```js
// [CORS comment]
files["keyname"] = {
    "title": "...",
    "overview": "...",
    "fields": [ ... ]
}
```

The Python scripts strip the JS wrapper with a regex to parse the inner JSON. The file key (`keyname`) is extracted from the `files["keyname"]` assignment and used as the HTML page name and as the target for reference links.

## Template Placeholders

`data/template.html` uses three placeholders replaced by `generate_html_files.py`:
- `<##>` — replaced with the file's `title`
- `<@@>` — replaced with the file key (used for script src paths and JS calls)
- `<$$>` — the entire line is replaced with `<script>` tags for each entry in `referenceFiles`
